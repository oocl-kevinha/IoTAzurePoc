new Vue({el:"#body",data:{shapes:[]},created:function(e){var o=this,t=L.map("map").setView([-34.397,150.644],8);L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(t),o.geoFenceTableInitialized||($("#geoFenceTable").bootstrapTable({striped:!0,toolbar:"#geoFenceTableToolbar",search:!0,showColumns:!0,uniqueId:"geoId",sortable:!0,pagination:!0,pageSize:25,sortName:"name",sortOrder:"asc",columns:[{field:"geoName",title:"Geo Fence Name",valign:"middle",sortable:!0,formatter:function(e){return'<a href="#" class="pointer geoName">'+e+"</a>"},events:{"click .geoName":function(e,t,a,n){o.clearSelection(),_.filter(o.shapes,{geoId:a.geoId})[0].shapeRef.setOptions({fillColor:"#ff0000",zIndex:99})}}},{field:"geoType",title:"Type",valign:"middle",sortable:!0},{field:"coords",title:"Geo Location",valign:"middle",sortable:!1,searchable:!1,formatter:function(e,o){return JSON.stringify(e.coordinates)+(o.geoType===google.maps.drawing.OverlayType.CIRCLE?", radius: "+o.radiusInMetre+" M":"")}},{field:"createdAt",title:"Created At",align:"center",valign:"middle",sortable:!0,searchable:!1,formatter:function(e){return moment(e).format("YYYY-MM-DD HH:mm")}},{field:"operation",valign:"middle",align:"center",sortable:!1,searchable:!1,formatter:function(e,o,t){return'<button type="button" class="btn btn-xs btn-danger delete" aria-label="Delete Geo Fence"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></button>'},events:{"click .delete":o.deleteGeoFence}}]}),o.$set("geoFenceTableInitialized",!0)),$("#geoFenceTable").bootstrapTable("load",[]),t.on("moveend",function(){o.loadGeoFenceInBound()}),o.$set("map",t),o.loadGeoFenceInBound()},methods:{deleteGeoFence:function(e,o,t,a){var n=this;$.httpHelper.sendDelete("/geo/"+t.geoId,function(e,o){$.dialog.info("Geo Fence is deleted");var a=_.filter(n.shapes,{geoId:t.geoId})[0];a.markerRef.setMap(null),n.removeShape(t.geoType,a.shapeRef)})},removeShape:function(e,o){var t=this;o.setMap(null),_.remove(t.shapes,{geoId:o.geoId}),$("#geoFenceTable").bootstrapTable("removeByUniqueId",o.geoId)},addShapeListenerAndTableRow:function(e,o){var t=this;o.geoId=e.geoId,o.setMap(t.$get("map"));var a=t.createShapeMarker(e,o);a.setMap(t.$get("map")),t.shapes.push({geoId:e.geoId,geoName:e.geoName,geoType:e.geoType,coords:e.coords.coordinates,shapeRef:o,markerRef:a,radiusInMetre:e.radiusInMetre,createdAt:e.createdAt})},createShapeMarker:function(e,o){var t={url:"https://maps.gstatic.com/mapfiles/place_api/icons/geocode-71.png",scaledSize:new google.maps.Size(25,25)},a=e.geoType===google.maps.drawing.OverlayType.CIRCLE?e.coords.coordinates:e.coords.coordinates[0][0];return new google.maps.Marker({icon:t,title:e.geoName,position:new google.maps.LatLng(a[1],a[0])})},addShape:function(e,o){var t=this;o.setMap(null),$.dialog.input("Input Geo-Fencing Name:",function(a){if(_.trim(a)){var n=t.getShapeSpec(_.trim(a),e,o);$.httpHelper.sendPost("/geo",n,function(e,a){t.addShapeListenerAndTableRow(e.data[0],o),$("#geoFenceTable").bootstrapTable("append",e.data[0]),$("#geoFenceTable").bootstrapTable("showRow",{uniqueId:e.data[0].geoId})})}else t.addShape(e,o)})},clearSelection:function(){var e=this;_.forEach(e.shapes,function(e){e.shapeRef.setOptions({fillColor:"#0fff00",zIndex:0})})},getShapeSpec:function(e,o,t){var a={geoName:e,geoType:o,coords:{type:o===google.maps.drawing.OverlayType.CIRCLE?"Point":"Polygon"}};return o===google.maps.drawing.OverlayType.CIRCLE?(a.radiusInMetre=_.round(t.getRadius(),2),a.coords.coordinates=[t.getCenter().lng(),t.getCenter().lat()]):(a.coords.coordinates=[],_.forEach(t.getPaths().getArray(),function(e){_.forEach(e.getArray(),function(e){a.coords.coordinates.push([e.lng(),e.lat()])})})),a},loadGeoFenceInBound:function(){var e=this;e.$get("gfXhr")&&e.$get("gfXhr").abort();var o=e.$get("map").getBounds(),t=[[o.getWest(),o.getNorth()],[o.getWest(),o.getSouth()],[o.getEast(),o.getSouth()],[o.getEast(),o.getNorth()]],a=$.httpHelper.sendPost("/geo/search/bound",t,function(e,o){console.log(e)});e.$set("gfXhr",a)}}});