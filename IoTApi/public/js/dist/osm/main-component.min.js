new Vue({el:"#body",data:{shapes:[],osm:location.href.indexOf("osm")>-1,colorConfig:{border:"#000000",fill:"#00ff00",fill_highlighted:"#ff0000"}},created:function(e){var o=this,t=L.map("map").setView([-34.397,150.644],8);L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(t),o.geoFenceTableInitialized||($("#geoFenceTable").bootstrapTable({striped:!0,toolbar:"#geoFenceTableToolbar",search:!0,showColumns:!0,uniqueId:"geoId",sortable:!0,pagination:!0,pageSize:25,sortName:"name",sortOrder:"asc",columns:[{field:"geoName",title:"Geo Fence Name",valign:"middle",sortable:!0,formatter:function(e){return'<a href="#" class="pointer geoName">'+e+"</a>"},events:{"click .geoName":function(e,t,a,r){o.clearSelection(),o.$set("zoomGeoId",a.geoId),o.$get("map").panTo("circle"==a.geoType?[a.coords.coordinates[1],a.coords.coordinates[0]]:[a.coords.coordinates[0][1],a.coords.coordinates[0][0]])}}},{field:"geoType",title:"Type",valign:"middle",sortable:!0},{field:"coords",title:"Geo Location",valign:"middle",sortable:!1,searchable:!1,formatter:function(e,o){return JSON.stringify(e.coordinates)+("circle"===o.geoType?", radius: "+o.radiusInMetre+" M":"")}},{field:"createdAt",title:"Created At",align:"center",valign:"middle",sortable:!0,searchable:!1,formatter:function(e){return moment(e).format("YYYY-MM-DD HH:mm")}},{field:"operation",valign:"middle",align:"center",sortable:!1,searchable:!1,formatter:function(e,o,t){return'<button type="button" class="btn btn-xs btn-danger delete" aria-label="Delete Geo Fence"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></button>'},events:{"click .delete":o.deleteGeoFence}}]}),o.$set("geoFenceTableInitialized",!0)),$("#geoFenceTable").bootstrapTable("load",[]);var a=new L.FeatureGroup;t.addLayer(a);var r=new L.Control.Draw({position:"topright",draw:{polygon:{allowIntersection:!0,shapeOptions:{color:o.colorConfig.border,fillColor:o.colorConfig.fill,fillOpacity:.5,weight:2}},circle:{shapeOptions:{color:o.colorConfig.border,fillColor:o.colorConfig.fill,fillOpacity:.5,weight:2},showRadius:!0,metric:!0,feet:!1,nautic:!1},polyline:!1,marker:!1,rectangle:!1},edit:{featureGroup:a,remove:!1,edit:!1}});t.addControl(r),t.on(L.Draw.Event.CREATED,function(e){o.addShape(e.layerType,e.layer)}),t.on("moveend",function(){o.loadGeoFenceInBound()}),L.control.scale({position:"bottomright"}).addTo(t),t.addControl(GeoSearch.GeoSearchControl({provider:new GeoSearch.OpenStreetMapProvider,style:"bar"})),o.$set("map",t),o.loadGeoFenceInBound()},methods:{deleteGeoFence:function(e,o,t,a){var r=this;$.httpHelper.sendDelete("/geo/"+t.geoId,function(e,o){$.dialog.info("Geo Fence is deleted");var a=_.filter(r.shapes,{geoId:t.geoId})[0];r.removeShape(t.geoType,a.shapeRef)})},removeShape:function(e,o){var t=this;o.remove(),_.remove(t.shapes,{geoId:o.geoId}),$("#geoFenceTable").bootstrapTable("removeByUniqueId",o.geoId)},addShape:function(e,o){var t=this;$.dialog.input("Input Geo-Fencing Name:",function(a){if(_.trim(a)){var r=t.getShapeSpec(_.trim(a),e,o);$.httpHelper.sendPost("/geo",r,function(e,a){o.addTo(t.$get("map")).bindPopup(e.data[0].geoName),t.$get("shapes").push({shapeRef:o,geoId:e.data[0].geoId}),$("#geoFenceTable").bootstrapTable("append",e.data[0]),$("#geoFenceTable").bootstrapTable("showRow",{uniqueId:e.data[0].geoId})})}else t.addShape(e,o)})},getShapeSpec:function(e,o,t){var a={geoName:e,geoType:o,coords:{type:"circle"===o?"Point":"Polygon"}};return"circle"===o?(a.radiusInMetre=_.round(t.getRadius(),2),a.coords.coordinates=[t.getLatLng().lng,t.getLatLng().lat]):(a.coords.coordinates=[],_.forEach(t.getLatLngs()[0],function(e){a.coords.coordinates.push([e.lng,e.lat])})),a},clearSelection:function(){var e=this;_.forEach(e.shapes,function(o){o.shapeRef.setStyle({fillColor:e.colorConfig.fill})})},loadGeoFenceInBound:function(){var e=this;e.$get("gfXhr")&&e.$get("gfXhr").abort();var o=e.$get("map").wrapLatLngBounds(e.$get("map").getBounds()),t=[[o.getWest(),o.getNorth()],[o.getWest(),o.getSouth()],[o.getEast(),o.getSouth()],[o.getEast(),o.getNorth()]],a=$.httpHelper.sendPost("/geo/search/bound",t,function(o,t){if(_.forEach(e.shapes,function(e){e.shapeRef.remove()}),e.$set("shapes",[]),_.forEach(o.data,function(o){var t;t="circle"===o.geoType?L.circle([o.coords.coordinates[1],o.coords.coordinates[0]],o.radiusInMetre,{color:e.colorConfig.border,fillColor:e.colorConfig.fill,fillOpacity:.5,weight:2}):L.polygon(_.map(o.coords.coordinates,function(e){return[e[1],e[0]]}),{color:e.colorConfig.border,fillColor:e.colorConfig.fill,fillOpacity:.5,weight:2}),t.addTo(e.$get("map")).bindPopup(o.geoName),e.$get("shapes").push({shapeRef:t,geoId:o.geoId})}),$("#geoFenceTable").bootstrapTable("load",o.data),e.$get("zoomGeoId")){var a=_.filter(e.shapes,{geoId:e.$get("zoomGeoId")})[0].shapeRef;a.openPopup(),a.setStyle({fillColor:e.colorConfig.fill_highlighted}),e.$delete("zoomGeoId")}$(".leaflet-control-geosearch .results").html(""),$(".leaflet-control-geosearch .results").toggleClass("active",!1)});e.$set("gfXhr",a)}}});